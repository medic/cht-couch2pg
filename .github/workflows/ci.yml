name: Build medic-couch2pg and run unit test cases

on: [ push, pull_request ]

env:
  CI_DOCKER_PASSWORD: XimlsIRTuP0u/sKpLav046CLS65RrKV0oKFKWCudfNQE7VUw7GWnKdMM4LJwprB4p5YSL/M4mEdMku/hdJhCx9YTlzQ5+O9qJ8Yiz9inqJKsz1lzoFxs8nhRlFTzpxi/c0EVmDH5J0nkRJvVZfpNML2GRPOsoYtiCnZF9dP5b9bxthJVgZq+gX9SNF61pmI0qtNiS7fsQ++4UYu5EZK/7Dmzi7mbEQGrfEcn8sgb3ywPnzSQQPwPQh4tUfLH/8JzTfBM9HFt0pd5vIdhjvxl7I88pdRCa61Yw7CZWOWhseVwcdMtANz3B8flOigd80WW/UHydRyKjfWDFD/XH6aR6sUqfa/fskHPYrpc6HXDIFS9D3TPU48ujGEtRbMbRNkAAVrAK4H9VqhL4WXjMOOUT4F5RrpcHE2jxj62F1u2jNljXpn75huHDKBh1nEGJ141HeRdJB+6chq9Ys7syvG0b98TMG7GQlG4pF1c2Zi2cewDrgc7N1wL4bwICBPXFphwxWz8MNzvVu9MmeF4O5T4RRv3274MdH9sq1YgEvt+tyPBU3YVQOE0VOUxj7QcQx/2f3Ye46sA/62YKp9itHjj1Arq9eHZZmwub5yPWRCedTQWSgzlSfvXHSP0o6ALVw7EBIYZdjuK8XZZIMyfVZ9IcOQM+b6vrvlj+yQhMmHH0TU=

jobs:
  build-and-test:
    name: Build medic-couch2pg
    runs-on: ubuntu-18.04

    strategy:
      matrix:
        node-version: [ 8, 10, 12 ]

    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.CI_DOCKER_USERNAME }}
          password: ${{ env.CI_DOCKER_PASSWORD }}

      - name: Checkout branch
        uses: actions/checkout@v2

      - name: Build
        run: docker-compose build --build-arg node_version=${{ matrix.node-version }} test
        env:
          COUCH2PG_SLEEP_MINS: 120
          COUCH2PG_DOC_LIMIT: 1000
          COUCH2PG_RETRY_COUNT: 5

      - name: Run tests
        run: docker-compose run test grunt test
